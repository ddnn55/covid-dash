<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COVID Dash</title>
    <style>
        body {
            margin: 0;
        }
        .header {
            text-align: center;
        }
        .title, .subtitle {
            text-align: center;
            display: inline-block;
        }
        .title {
            font-size: 22px;
        }
        .subtitle {
            font-size: 14px;
            margin-left: 20px;
        }
        .chart-container {
            height: 80vh;
            /* min-width: 800px; */
        }
        .layout {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .chart-container {
            flex: 1;
        }
    </style>

</head>

<body>
    <div class="layout">
        <div class="header">
            <div class="title">
                COVID-19: New Cases per 100k People by U.S. Region
            </div>
            <div class="subtitle">Data: <a href="https://github.com/nytimes/covid-19-data">NYTimes</a>, <a href="https://en.wikipedia.org/wiki/List_of_states_and_territories_of_the_United_States_by_population#State_rankings">Wikipedia</a>. Fork/contribute on <a href="https://github.com/gimlids/covid-dash/issues">GitHub</a>.
            </div>
        </div>
    
        <div class="chart-container"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.15/lodash.min.js"></script>
    <script src="lib/highcharts.js"></script>
    <script>
        const minDay = "2020-03-01";

        const chartContainer = document.querySelector('.chart-container');
        const table = document.querySelector('.table');

        const loadDsv = async (url, separator) => {
            const result = await fetch(url);
            const dsvText = await result.text();
            return dsvText.split('\n').slice(1).map(line => line.split(separator));
        };

        const loadCovidRows = async url => (await loadDsv(url, ',')).map(([day, region, __, positives, deaths]) => [day, region, +positives, +deaths]).filter(row => row[0] >= minDay);

        const sevenDayAverage = (rows, r) => {
            const startIndex = Math.max(0, r-6);
            const windowRows = rows.slice(startIndex, r+1);
            const sum = _.sum(windowRows.map(row => row[2]));
            const count = (r+1-startIndex);
            return sum / count;
        };

        (async () => {

            const populationRows = await loadDsv("us-states-population-april-1-2020.tsv", "\t");
            let populations = {};
            populationRows.forEach(([name, pop]) => {
                populations[name] = +pop.split(',').join('');
            });
            // console.log(populations)

            const covidRows = await loadCovidRows("https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-states.csv");
            const countyRows = await loadCovidRows("https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv");
            console.log({countyRows});

            // table.innerHTML = JSON.stringify(covidRows, null, 2);
            const byDay = _.groupBy(covidRows, row => row[0]);
            // console.log(byDay)

            const byRegion = _.groupBy(covidRows, row => row[1]);
            for(const region in byRegion) {
                
                // calculate daily change
                byRegion[region] = byRegion[region].map((row, r) => {
                    const changeCases = r === 0 ? row[2] : row[2] - byRegion[region][r-1][2];
                    // const sevenDayAverage = 
                    return [
                        row[0],
                        row[1],
                        changeCases
                    ];
                });

                // calculate 7 day average change per capita
                byRegion[region] = byRegion[region].map((row, r) => {
                    return [
                        row[0],
                        row[1],
                        row[2],
                        100000 * sevenDayAverage(byRegion[region], r) / populations[region]
                    ];
                });
                
                byRegion[region] = _.keyBy(byRegion[region], row => row[0]);
            }
            console.log(byRegion)

            const highchartsSeries = _.sortBy(Object.keys(byRegion).map(region => ({
                name: region,
                data: Object.keys(byDay).map(day => byRegion[region][day] ? byRegion[region][day][3] : 0)
            })), regionSeries => regionSeries.name);
            console.log(highchartsSeries)

            Highcharts.chart(chartContainer, {
                xAxis: {
                    // categories: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
                    categories: Object.keys(byDay),
                },
                yAxis: {
                    floor: 0
                },

                chart: {
                    // height: innerHeight
                },
                title: {
                    text: ""
                },

                series: highchartsSeries,

                plotOptions: {
                    series: {
                        marker: {
                            enabled: false
                        }
                    }
                },
                
                legend: {
                    enabled: true,
                    layout: 'vertical',
                    align: 'right'
                }
            });
        })();

    </script>
</body>

</html>