<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COVID Dash</title>
    <style>
        .table {
            font-family: monospace;
            white-space: pre;
        }
    </style>

</head>

<body>
    <div class="chart-container"></div>
    <div class="table"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.15/lodash.min.js"></script>
    <script src="lib/highcharts.js"></script>
    <script>
        const chartContainer = document.querySelector('.chart-container');
        const table = document.querySelector('.table');

        const loadDsv = async (url, separator) => {
            const result = await fetch(url);
            const dsvText = await result.text();
            return dsvText.split('\n').slice(1).map(line => line.split(separator));
        };

        const sevenDayAverage = (rows, r) => {
            const startIndex = Math.max(0, r-6);
            const windowRows = rows.slice(startIndex, r+1);
            const sum = _.sum(windowRows.map(row => row[2]));
            const count = (r+1-startIndex);
            return sum / count;
        };

        (async () => {

            const populationRows = await loadDsv("us-states-population-april-1-2020.tsv", "\t");
            let populations = {};
            populationRows.forEach(([name, pop]) => {
                populations[name] = +pop.split(',').join('');
            });
            // console.log(populations)

            const covidRows = (await loadDsv("https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-states.csv", ',')).map(([day, region, __, positives, deaths]) => [day, region, +positives, +deaths]);
            console.log(covidRows)

            // table.innerHTML = JSON.stringify(covidRows, null, 2);
            const byDay = _.groupBy(covidRows, row => row[0]);
            // console.log(byDay)

            const byRegion = _.groupBy(covidRows, row => row[1]);
            for(const region in byRegion) {
                
                // calculate daily change
                byRegion[region] = byRegion[region].map((row, r) => {
                    const changeCases = r === 0 ? row[2] : row[2] - byRegion[region][r-1][2];
                    // const sevenDayAverage = 
                    return [
                        row[0],
                        row[1],
                        changeCases
                    ];
                });

                // calculate 7 day average change per capita
                byRegion[region] = byRegion[region].map((row, r) => {
                    return [
                        row[0],
                        row[1],
                        row[2],
                        sevenDayAverage(byRegion[region], r) / populations[region]
                    ];
                });
                
                byRegion[region] = _.keyBy(byRegion[region], row => row[0]);
            }
            console.log(byRegion)

            const highchartsSeries = Object.keys(byRegion).map(region => ({
                name: region,
                data: Object.keys(byDay).map(day => byRegion[region][day] ? byRegion[region][day][3] : 0)
            }));
            console.log(highchartsSeries)

            Highcharts.chart(chartContainer, {
                xAxis: {
                    // categories: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
                    categories: Object.keys(byDay)
                },
                yAxis: {
                    floor: 0
                },

                chart: {
                    height: 700
                },
                title: {
                    text: 'U.S. COVID-19 Cases per Capita by Day'
                },

                series: highchartsSeries,
                
                legend: {
                    enabled: false
                }
            });
        })();

    </script>
</body>

</html>