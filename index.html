<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COVID Dash</title>
    <style>
        .table {
            font-family: monospace;
            white-space: pre;
        }
    </style>

</head>

<body>
    <div class="chart-container"></div>
    <div class="table"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.15/lodash.min.js"></script>
    <script src="lib/highcharts.js"></script>
    <script>
        const chartContainer = document.querySelector('.chart-container');
        const table = document.querySelector('.table');

        const loadDsv = async (url, separator) => {
            const result = await fetch(url);
            const dsvText = await result.text();
            return dsvText.split('\n').slice(1).map(line => line.split(separator));
        };

        (async () => {
            const covidRows = (await loadDsv("https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-states.csv", ',')).map(([day, region, __, positives, deaths]) => [day, region, +positives, +deaths]);

            table.innerHTML = JSON.stringify(covidRows, null, 2);
            const byDay = _.groupBy(covidRows, row => row[0]);
            // console.log(byDay)

            const populationRows = await loadDsv("us-states-population-april-1-2020.tsv", "\t");
            let populations = {};
            populationRows.forEach(([name, pop]) => {
                populations[name] = +pop.split(',').join('');
            });
            // console.log(populations)

            const byRegion = _.groupBy(covidRows, row => row[1]);
            for(const region in byRegion) {
                byRegion[region] = _.groupBy(byRegion[region], row => row[0]);
            }
            console.log(byRegion)

            Highcharts.chart(chartContainer, {
                xAxis: {
                    // categories: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
                    categories: Object.keys(byDay)
                },

                series: [{
                    data: [29.9, 71.5, 106.4, 129.2, 144.0, 176.0, 135.6, 148.5, 216.4, 194.1, 95.6, 54.4]
                }, {
                    data: [216.4, 194.1, 95.6, 54.4, 29.9, 71.5, 106.4, 129.2, 144.0, 176.0, 135.6, 148.5],
                    lineWidth: 5
                }, {
                    data: byRegion['California']
                }]
            });
        })();

    </script>
</body>

</html>